<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Messages - LINE Mini App</title>
    <link id="favicon" rel="icon" href="https://developers.line.biz/images/icons/products/light/mini.svg">
    <link id="apple-touch-icon" rel="apple-touch-icon" href="https://developers.line.biz/images/icons/products/light/mini.svg">
    <meta name="description" content="service messages for MINI App" />
    <meta name="author" content="iton5" />
    <meta property="og:title" content="service messages-iton5-thailand" />
    <meta property="og:description" content="service messages for MINI App" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://cdn-icons-png.flaticon.com/128/134/134808.png" />
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #06C755; 
            --primary-gradient: linear-gradient(135deg, #06C755 0%, #00B900 100%);
            --background-color: #F2F5F8;
            --card-bg: #FFFFFF;
            --text-main: #1A1A1A;
            --text-secondary: #888888;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --radius: 20px;
            --error-color: #FF4B4B;
            --success-color: #06C755;
            --warning-color: #FFA500;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-main);
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 400px;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 40px 30px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .icon-wrapper {
            width: 80px;
            height: 80px;
            background: #E8FAF0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .icon-wrapper svg {
            width: 40px;
            height: 40px;
            fill: var(--primary-color);
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: var(--primary-gradient);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(6, 199, 85, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(6, 199, 85, 0.4);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
       
        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-container {
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            max-height: 0;
            overflow: hidden;
        }

        .status-container.show {
            opacity: 1;
            max-height: 200px;
            margin-top: 20px;
        }

        .status-success {
            background-color: rgba(6, 199, 85, 0.1);
            border: 1px solid rgba(6, 199, 85, 0.2);
            color: var(--success-color);
        }

        .status-error {
            background-color: rgba(255, 75, 75, 0.1);
            border: 1px solid rgba(255, 75, 75, 0.2);
            color: var(--error-color);
        }

        .status-warning {
            background-color: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.2);
            color: var(--warning-color);
        }
       
        #userProfile {
            display: none;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(6, 199, 85, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(6, 199, 85, 0.1);
        }

        #userProfile img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
        }

        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-secondary);
            text-align: left;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-toggle {
            display: block;
            margin-top: 15px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            text-align: center;
            user-select: none;
        }

        .debug-toggle:hover {
            color: var(--primary-color);
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="icon-wrapper">
            <svg viewBox="0 0 24 24">
                <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/>
            </svg>
        </div>

        <div id="userProfile">
            <img id="userImage" src="" alt="User">
            <div class="user-name" id="userName"></div>
        </div>

        <h1>แจ้งเตือนการจอง</h1>
        <p>กดปุ่มด้านล่างเพื่อส่ง Service Message <br>ยืนยันรายละเอียดการจองของคุณ</p>

        <button id="sendBtn" class="btn">
            <span id="btnText">ส่งการแจ้งเตือน</span>
            <div id="btnLoader" class="spinner"></div>
        </button>

        <div id="statusContainer" class="status-container">
            <div id="statusMessage"></div>
        </div>

        <div class="debug-info" id="debugInfo"></div>
        <div class="debug-toggle" id="debugToggle">แสดงข้อมูล Debug</div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        // เปลี่ยนค่าเหล่านี้ตามการตั้งค่าของคุณ
        const LIFF_ID = "2005634758-NaWR4bKr"; // ใส่ LIFF ID จริงของคุณที่นี่
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzTYOO14YVHVhOT47fFjltIHwhoZ9YMrECviBApcMZCWVAxiqdEnjxda_HqUIGhw9Tv/exec";
        
        // ==================== DOM ELEMENTS ====================
        const btn = document.getElementById('sendBtn');
        const btnText = document.getElementById('btnText');
        const btnLoader = document.getElementById('btnLoader');
        const statusContainer = document.getElementById('statusContainer');
        const statusMessage = document.getElementById('statusMessage');
        const userProfile = document.getElementById('userProfile');
        const userImage = document.getElementById('userImage');
        const userName = document.getElementById('userName');
        const debugInfo = document.getElementById('debugInfo');
        const debugToggle = document.getElementById('debugToggle');
        
        // ==================== STATE VARIABLES ====================
        let isInitialized = false;
        let isSending = false;
        let debugLog = [];
        
        // ==================== LOGGING FUNCTIONS ====================
        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`[${timestamp}] ${message}`);
            
            // Update debug info display
            debugInfo.innerHTML = debugLog.map(log => 
                `<div style="margin-bottom: 5px; font-family: monospace;">${log}</div>`
            ).join('');
            
            console.log(`[DEBUG] ${message}`);
        }
        
        function toggleDebug() {
            if (debugInfo.style.display === 'block') {
                debugInfo.style.display = 'none';
                debugToggle.textContent = 'แสดงข้อมูล Debug';
            } else {
                debugInfo.style.display = 'block';
                debugToggle.textContent = 'ซ่อนข้อมูล Debug';
            }
        }
        
        // ==================== UI FUNCTIONS ====================
        function setLoading(isLoading) {
            if (isLoading) {
                btn.disabled = true;
                btnText.style.display = 'none';
                btnLoader.style.display = 'block';
                isSending = true;
            } else {
                btn.disabled = false;
                btnText.style.display = 'block';
                btnLoader.style.display = 'none';
                isSending = false;
            }
        }
        
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusContainer.className = 'status-container';
            
            // Set status type
            switch(type) {
                case 'success':
                    statusContainer.classList.add('status-success');
                    break;
                case 'error':
                    statusContainer.classList.add('status-error');
                    break;
                case 'warning':
                    statusContainer.classList.add('status-warning');
                    break;
                default:
                    statusContainer.classList.add('status-warning');
            }
            
            // Show container
            setTimeout(() => {
                statusContainer.classList.add('show');
            }, 10);
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    hideStatus();
                }, 5000);
            }
        }
        
        function hideStatus() {
            statusContainer.classList.remove('show');
            setTimeout(() => {
                statusContainer.className = 'status-container';
            }, 300);
        }
        
        // ==================== GAS COMMUNICATION FUNCTIONS ====================
        async function sendToGAS(method, data) {
            logDebug(`ส่งคำขอไปยัง GAS (${method})...`);
            
            try {
                // สำหรับ Google Apps Script Web App
                const url = GAS_WEB_APP_URL;
                
                if (method === 'GET') {
                    // ใช้ URL parameters สำหรับ GET request
                    const params = new URLSearchParams();
                    params.append('postData', JSON.stringify(data));
                    
                    const response = await fetch(`${url}?${params.toString()}`, {
                        method: 'GET',
                        mode: 'no-cors' // ต้องใช้ no-cors สำหรับ GAS
                    });
                    
                    logDebug('ส่ง GET request สำเร็จ (no-cors mode)');
                    return { success: true, result: { message: "Request sent via GET" } };
                    
                } else if (method === 'POST') {
                    // สำหรับ POST request เราต้องใช้ Form submission
                    return new Promise((resolve, reject) => {
                        // สร้าง form element
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = url;
                        form.style.display = 'none';
                        
                        // สร้าง input สำหรับข้อมูล
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'postData';
                        input.value = JSON.stringify(data);
                        form.appendChild(input);
                        
                        // สร้าง iframe สำหรับรับ response
                        const iframe = document.createElement('iframe');
                        iframe.name = 'gasResponseFrame';
                        iframe.style.display = 'none';
                        document.body.appendChild(iframe);
                        document.body.appendChild(form);
                        
                        // ตั้งค่า form target เป็น iframe
                        form.target = 'gasResponseFrame';
                        
                        // ตั้งค่า event listener สำหรับ iframe
                        iframe.onload = function() {
                            try {
                                logDebug('ได้รับ response จาก GAS');
                                
                                // พยายามอ่าน response จาก iframe
                                let responseText = '';
                                try {
                                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                    responseText = iframeDoc.body.textContent || iframeDoc.documentElement.textContent;
                                } catch (e) {
                                    logDebug('ไม่สามารถอ่าน iframe content: ' + e.message);
                                }
                                
                                if (responseText) {
                                    const result = JSON.parse(responseText);
                                    logDebug(`Response: ${JSON.stringify(result).substring(0, 200)}...`);
                                    resolve(result);
                                } else {
                                    // ถ้าไม่มี response ให้ assume สำเร็จ
                                    logDebug('ไม่มี response text, assume สำเร็จ');
                                    resolve({ success: true, result: { message: "Form submission successful" } });
                                }
                            } catch (error) {
                                logDebug('Error reading iframe response: ' + error.message);
                                reject(error);
                            } finally {
                                // Cleanup
                                setTimeout(() => {
                                    if (iframe.parentNode) document.body.removeChild(iframe);
                                    if (form.parentNode) document.body.removeChild(form);
                                }, 1000);
                            }
                        };
                        
                        iframe.onerror = function(error) {
                            logDebug('iframe error: ' + error);
                            reject(new Error('iframe error'));
                        };
                        
                        // ส่ง form
                        form.submit();
                        logDebug('Form submitted ไปยัง GAS');
                        
                        // Timeout fallback
                        setTimeout(() => {
                            if (iframe.parentNode) {
                                logDebug('Request timeout after 30s');
                                reject(new Error('Request timeout'));
                            }
                        }, 30000);
                        
                    });
                }
            } catch (error) {
                logDebug('Error in sendToGAS: ' + error.message);
                throw error;
            }
        }
        
        // ==================== LIFF INITIALIZATION ====================
        async function initializeLIFF() {
            logDebug('เริ่มต้น LIFF...');
            
            try {
                showStatus('กำลังเริ่มต้นระบบ...', 'warning');
                
                await liff.init({
                    liffId: LIFF_ID,
                    withLoginOnExternalBrowser: true
                });
                
                logDebug('LIFF init สำเร็จ');
                
                if (!liff.isLoggedIn()) {
                    logDebug('ผู้ใช้ไม่ได้ล็อกอิน, redirect ไปล็อกอิน');
                    showStatus('กำลังเข้าสู่ระบบ...', 'warning');
                    
                    // ใช้ redirect แทน login popup เพื่อความเสถียร
                    window.location.href = liff.loginUrl;
                    return;
                }
                
                // ดึงข้อมูลผู้ใช้
                const profile = await liff.getProfile();
                logDebug(`ได้รับข้อมูลผู้ใช้: ${profile.displayName}`);
                
                // แสดงข้อมูลผู้ใช้
                userImage.src = profile.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
                userName.textContent = profile.displayName;
                userProfile.style.display = 'block';
                
                // ดึง context
                const context = liff.getContext();
                logDebug(`LIFF Context: ${JSON.stringify(context)}`);
                
                // อัพเดทปุ่ม
                btn.addEventListener('click', sendNotification);
                
                isInitialized = true;
                showStatus('ระบบพร้อมใช้งาน', 'success');
                
            } catch (error) {
                logDebug('LIFF init error: ' + error.message);
                
                if (error.message.includes('was not found')) {
                    showStatus('❌ LIFF App ไม่พบ กรุณาตรวจสอบ LIFF ID', 'error');
                } else {
                    showStatus('❌ เกิดข้อผิดพลาดในการเริ่มต้น: ' + error.message, 'error');
                }
                
                // แสดงข้อแนะนำ
                setTimeout(() => {
                    showStatus('ตรวจสอบ LIFF ID ใน LINE Developers Console', 'warning');
                }, 2000);
            }
        }
        
        // ==================== NOTIFICATION SENDING ====================
        async function sendNotification() {
            if (!isInitialized) {
                showStatus('กรุณารอระบบเริ่มต้นให้เสร็จสิ้น', 'error');
                return;
            }
            
            if (isSending) {
                return;
            }
            
            if (!liff.isLoggedIn()) {
                showStatus('กรุณาเข้าสู่ระบบก่อน', 'error');
                setTimeout(() => {
                    liff.login({ redirectUri: window.location.href });
                }, 1000);
                return;
            }
            
            logDebug('เริ่มส่ง notification...');
            setLoading(true);
            showStatus('กำลังส่งข้อความ...', 'warning');
            
            try {
                // ดึง access token
                const accessToken = liff.getAccessToken();
                if (!accessToken) {
                    throw new Error('ไม่พบ Access Token');
                }
                
                logDebug('ได้ Access Token มาแล้ว');
                
                // สร้าง request data
                const requestData = {
                    liffAccessToken: accessToken,
                    timestamp: new Date().toISOString(),
                    source: 'LIFF_APP'
                };
                
                logDebug(`Request data: ${JSON.stringify(requestData)}`);
                
                // ส่งไปยัง GAS (ลองทั้ง POST และ GET)
                let result;
                
                try {
                    // ลองใช้ POST ก่อน (recommended)
                    logDebug('พยายามส่งด้วย POST...');
                    result = await sendToGAS('POST', requestData);
                } catch (postError) {
                    logDebug(`POST failed: ${postError.message}, ลอง GET...`);
                    
                    // ลองใช้ GET ถ้า POST ล้มเหลว
                    result = await sendToGAS('GET', requestData);
                }
                
                if (result.success) {
                    logDebug('ส่ง notification สำเร็จ');
                    showStatus('✅ ส่งข้อความสำเร็จเรียบร้อย!', 'success');
                    
                    // แสดงข้อความสำเร็จแบบพิเศษ
                    btnText.textContent = 'ส่งแล้ว ✓';
                    setTimeout(() => {
                        btnText.textContent = 'ส่งการแจ้งเตือน';
                    }, 2000);
                    
                } else {
                    throw new Error(result.error || 'การส่งไม่สำเร็จ');
                }
                
            } catch (error) {
                logDebug('Error sending notification: ' + error.message);
                console.error('Send error:', error);
                
                // แสดงข้อความ error ที่ user-friendly
                let errorMessage = 'เกิดข้อผิดพลาดในการส่งข้อความ';
                
                if (error.message.includes('timeout')) {
                    errorMessage = 'การเชื่อมต่อใช้เวลานานเกินไป กรุณาลองใหม่';
                } else if (error.message.includes('Access Token')) {
                    errorMessage = 'กรุณาล็อกอินใหม่อีกครั้ง';
                }
                
                showStatus(`❌ ${errorMessage}: ${error.message}`, 'error');
                
            } finally {
                setLoading(false);
            }
        }
        
        // ==================== INITIALIZE APP ====================
        async function initializeApp() {
            logDebug('เริ่มต้นแอปพลิเคชัน...');
            
            // ตั้งค่า debug toggle
            debugToggle.addEventListener('click', toggleDebug);
            
            // เริ่มต้น LIFF
            await initializeLIFF();
            
            // ตั้งค่าให้รีเฟรชเมื่อกลับมาจาก login
            if (window.location.search.includes('code=')) {
                logDebug('ตรวจพบ callback จาก LINE login');
                setTimeout(() => {
                    window.location.href = window.location.origin + window.location.pathname;
                }, 1000);
            }
        }
        
        // ==================== START APP ====================
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // เพิ่ม fallback ถ้า LIFF โหลดช้า
        setTimeout(() => {
            if (!isInitialized && window.liff) {
                logDebug('Fallback: กำลังเริ่มต้น LIFF อีกครั้ง...');
                initializeLIFF();
            }
        }, 3000);
        
    </script>
</body>
</html>
